<!-- /hud_dashboard.html -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CryptoBavaro — HUD Dashboard</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0b0c10;color:#e7eaf0;margin:0;padding:24px;}
    .card{background:#12141a;border:1px solid #1c1f27;border-radius:16px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.25);max-width:960px;margin:0 auto;}
    h1{font-size:20px;margin:0 0 14px 0}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .pill{background:#1a2333;color:#9fc7ff;border-radius:999px;padding:6px 10px;font-size:12px}
    .muted{color:#9aa3b2}
    .k{display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:12px;margin-top:12px}
    .kv{background:#0f1824;border:1px solid #1c2738;border-radius:12px;padding:12px}
    .kv b{display:block;font-size:12px;color:#8fa4be;margin-bottom:4px}
    .kv span{font-size:16px}
    button{background:#2f6fed;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .ai{margin-top:16px;background:#0d1320;border:1px dashed #2b3a55;border-radius:12px;padding:12px;line-height:1.45}
    .list{margin-top:16px;border-top:1px solid #1c1f27}
    .rowi{display:grid;grid-template-columns:140px 120px 120px 1fr;gap:10px;align-items:center;padding:10px 0;border-bottom:1px dashed #1b212d}
    .rowi b{font-weight:600}
    .ts{font-feature-settings:"tnum" 1;font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h1>Аналитический Dashboard</h1>
      <div>
        <button id="btn">Обновить</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="pill" id="pill-sym">—</span>
      <span class="pill" id="pill-tf">—</span>
      <span class="pill" id="pill-count">—</span>
    </div>

    <div class="k">
      <div class="kv"><b>Цена</b><span id="k-price">—</span></div>
      <div class="kv"><b>UTC время</b><span class="ts" id="k-t">—</span></div>
      <div class="kv"><b>Версия</b><span id="k-ver">—</span></div>
      <div class="kv"><b>Snapshot</b><span id="k-snap">—</span></div>
    </div>

    <div class="ai" id="ai">—</div>

    <div class="list" id="list"></div>
  </div>

<script>
const sym = 'BINANCE:BTCUSDT';
const tf  = 5;

async function fetchJSON(url) {
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}
function fmt(n, d=1){ return (n==null?'—': Number(n).toFixed(d)); }

async function refresh() {
  const btn = document.getElementById('btn');
  btn.disabled = true;
  try{
    const api = await fetchJSON(`/api/hud_api_strict.php?sym=${encodeURIComponent(sym)}&tf=${tf}&limit=20`);
    const ai  = await fetchJSON(`/api/hud_ai.php?sym=${encodeURIComponent(sym)}&tf=${tf}`);

    document.getElementById('pill-sym').textContent = api.sym;
    document.getElementById('pill-tf').textContent  = `${api.tf}m`;
    document.getElementById('pill-count').textContent = `${api.count} записей`;

    if (api.items.length){
      const last = api.items[0];
      document.getElementById('k-price').textContent = fmt(last.price,1);
      document.getElementById('k-t').textContent     = last.t_utc.replace(' ', 'T');
      document.getElementById('k-ver').textContent   = last.ver;
      document.getElementById('k-snap').textContent  = last.snapshot_id;
    }

    document.getElementById('ai').textContent = ai.ok ? ai.summary : 'Нет данных';

    // Table
    const list = document.getElementById('list');
    list.innerHTML = '';
    for (const it of api.items){
      const row = document.createElement('div');
      row.className = 'rowi';
      row.innerHTML = `
        <span class="ts">${it.t_utc.replace(' ', 'T')}</span>
        <span>${fmt(it.price,1)}</span>
        <span>${it.ver}</span>
        <span class="muted">${(it.result_json||'').slice(0,120)}...</span>
      `;
      list.appendChild(row);
    }
  }catch(e){
    alert('Ошибка загрузки: '+e.message);
  }finally{
    btn.disabled = false;
  }
}

document.getElementById('btn').addEventListener('click', refresh);
refresh();
</script>
</body>
</html>
