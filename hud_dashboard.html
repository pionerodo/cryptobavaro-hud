<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>HUD Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121821;
      --muted: #7f8ea3;
      --text: #d7e3f0;
      --accent: #3ba776;
      --accent-2: #2d6cdf;
      --danger: #e86b6b;
      --code-bg: #0d1218;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{max-width:1280px; margin:24px auto; padding:0 16px}
    .header{
      display:flex; align-items:center; gap:12px; margin-bottom:12px;
    }
    .badge{padding:4px 10px; border-radius:999px; background:#141b25; color:var(--muted); font-weight:600}
    .spacer{flex:1}
    .vsmall{font-size:12px; color:#9fb0c6}
    .controls{
      display:flex; gap:8px; align-items:center; margin:12px 0 18px;
    }
    select,input,button{
      background:#0e141c; color:var(--text); border:1px solid #1a2330; border-radius:8px;
      padding:8px 10px; outline:none;
    }
    select:focus,input:focus,button:focus{border-color:#2b3a4f}
    button{cursor:pointer; font-weight:600}
    .btn-acc{background:#0e1a14; border-color:#163a2a}
    .btn-acc:hover{background:#102018}
    .btn-blue{background:#0e1524; border-color:#203660}
    .btn-blue:hover{background:#121a2c}
    .grid{
      display:grid; gap:12px;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto 420px auto 180px;
      grid-template-areas:
        "a b"
        "a b"
        "c btm"
        "diag diag";
    }
    .card{background:var(--panel); border:1px solid #1a2330; border-radius:14px; overflow:hidden}
    .card h3{margin:0; padding:10px 12px; border-bottom:1px solid #1a2330; font-size:14px; color:#9fb0c6}
    .card .body{padding:8px}
    pre{
      margin:0; padding:12px; background:var(--code-bg); border:1px solid #1a2330; border-radius:10px;
      overflow:auto; white-space:pre; max-height:360px; color:#9ff5b2;
      font:12.5px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .muted{color:var(--muted)}
    .ok{color:var(--accent)}
    .err{color:var(--danger)}
    .d1{grid-area:a}
    .d2{grid-area:b}
    .d3{grid-area:c}
    .d4{grid-area:btm}
    .d5{grid-area:diag}
    .foot{margin-top:10px; color:#73859b; font-size:12px}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <span class="badge">HUD Dashboard</span>
      <div class="spacer"></div>
      <span class="vsmall">ver <span id="ver">2025‑08‑25</span></span>
    </div>

    <div class="controls">
      <label class="small muted">Пара:&nbsp;</label>
      <input id="sym" value="BINANCE:BTCUSDT" style="min-width:220px"/>
      <label class="small muted">&nbsp;TF:&nbsp;</label>
      <select id="tf">
        <option value="1">1m</option>
        <option value="3">3m</option>
        <option value="5" selected>5m</option>
        <option value="15">15m</option>
      </select>
      <button class="btn-blue" onclick="doAnalysis()">Получить анализ</button>
      <button class="btn-acc"  onclick="doCorridor()">Проверить «коридор сделки»</button>
      <span id="ping" class="small muted"></span>
    </div>

    <div class="grid">
      <div class="card d1">
        <h3>Текущий анализ</h3>
        <div class="body">
          <pre id="out_now">—</pre>
        </div>
      </div>

      <div class="card d2">
        <h3>Сигнал входа (коридор)</h3>
        <div class="body">
          <pre id="out_entry">—</pre>
        </div>
      </div>

      <div class="card d3">
        <h3>Последние записи (строго UTC)</h3>
        <div class="body">
          <pre id="out_hist">—</pre>
          <div class="foot muted small">Источник данных: API HUD (cryptobavaro.online/api/*)</div>
        </div>
      </div>

      <div class="card d5">
        <h3>Диагностика запросов</h3>
        <div class="body">
          <pre id="log"></pre>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = sel => document.querySelector(sel);

function tfNum(){
  return $('#tf').value.trim() || '5';
}
function symStr(){
  return $('#sym').value.trim() || 'BINANCE:BTCUSDT';
}

function asJson(o){ return JSON.stringify(o, null, 2); }
function setPre(id, data){ $(id).textContent = (typeof data === 'string')? data : asJson(data); }
function logLine(s){ const el = $('#log'); el.textContent += s + "\n"; el.scrollTop = el.scrollHeight; }

async function call(url, params){
  const qs = new URLSearchParams(params).toString();
  const full = `${url}?${qs}`;
  const t0 = performance.now();
  try{
    const r = await fetch(full, {cache: 'no-store'});
    const dt = (performance.now()-t0).toFixed(0);
    const text = await r.text();
    try{
      const json = JSON.parse(text);
      logLine(`[${new Date().toISOString().replace('T',' ').slice(0,19)}Z] GET  ${url}?${qs}  •  ${r.status}  •  ${dt} ms`);
      return json;
    }catch(_){
      logLine(`[${new Date().toISOString().replace('T',' ').slice(0,19)}Z] GET  ${url}?${qs}  •  ${r.status}  •  ${dt} ms  •  TEXT`);
      return { ok:false, error:'bad_json', body:text };
    }
  }catch(e){
    logLine(`[${new Date().toISOString().replace('T',' ').slice(0,19)}Z] ERR  ${url}?${qs}  •  ${e}`);
    return { ok:false, error:e.message || 'fetch_error' };
  }
}

// блок «последние записи» читаем со строгого API (как и раньше)
async function loadStrict(){
  const res = await call('/api/hud_api_strict.php', {
    sym: symStr(), tf: tfNum(), limit: 3
  });
  setPre('#out_hist', res);
}

async function doAnalysis(){
  const res = await call('/api/hud_ai.php', {
    kind: 'analysis', sym: symStr(), tf: tfNum()
  });
  setPre('#out_now', res);
}

async function doCorridor(){
  const res = await call('/api/hud_ai.php', {
    kind: 'corridor', sym: symStr(), tf: tfNum(), limit: 3
  });
  setPre('#out_entry', res);
}

async function probe(){
  try{
    const t0 = performance.now();
    const r = await fetch('/analyze.php?mode=probe', {cache:'no-store'});
    const text = await r.text();
    const dt = (performance.now()-t0).toFixed(0);
    logLine(`[${new Date().toISOString().replace('T',' ').slice(0,19)}Z] GET  /analyze.php?mode=probe  •  ${dt} ms  \\ BODY: ${text.trim().slice(0,120)}`);
  }catch(e){
    logLine(`[probe] ${e}`);
  }
}

async function boot(){
  await probe();
  await doAnalysis();
  await doCorridor();
  await loadStrict();
}

document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
