<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HUD Dashboard</title>
<style>
  :root{
    --bg:#0e1116;--panel:#161b22;--panel-2:#0f1620;--text:#c9d1d9;--muted:#8b949e;
    --green:#2ea043;--cyan:#3fbff0;--red:#f85149;--yellow:#f2cc60;--mono:#a0ffa0;
    --border:#262b36;--chip:#202734;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);background:var(--panel)}
  .left, .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:16px;font-weight:600;letter-spacing:.3px}
  select,button{background:var(--chip);color:var(--text);border:1px solid var(--border);border-radius:8px;height:32px;padding:6px 10px}
  button{cursor:pointer}
  button.primary{background:#1f6feb;border-color:#2d6cdf}
  .okdot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;margin-left:6px}
  .grid{display:grid;gap:12px;padding:12px}
  @media(min-width:1100px){
    .grid{
      grid-template-columns:1fr 1fr;
      grid-template-areas:
       "a b"
       "c d";
    }
  }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .card h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;background:var(--panel-2)}
  .content{padding:12px}
  .row{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0}
  .chip{background:var(--chip);border:1px solid var(--border);padding:4px 8px;border-radius:999px;color:var(--muted)}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px}
  pre{margin:0;background:#0b1117;border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--mono);overflow:auto;max-height:46vh}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
  .green{color:var(--green)} .red{color:var(--red)} .yellow{color:var(--yellow)}
</style>
</head>
<body>

<header>
  <div class="left">
    <h1>HUD Dashboard</h1>
    <span class="chip">ver: <span id="ver">—</span></span>
  </div>
  <div class="right">
    <label>Пара:</label>
    <select id="sym">
      <option>BINANCE:BTCUSDT</option>
    </select>
    <label>TF:</label>
    <select id="tf">
      <option value="5">5m</option>
      <option value="15">15m</option>
      <option value="60">1h</option>
    </select>
    <button id="btnNow" class="primary">Получить анализ</button>
    <button id="btnCorridor">Проверить «коридор сделки»</button>
    <span id="oklamp" class="okdot" title="API OK"></span>
  </div>
</header>

<main class="grid">
  <!-- A -->
  <section class="card" style="grid-area:a">
    <h2>Текущий анализ</h2>
    <div class="content">
      <div class="row">
        <span class="chip">symbol: <span id="a-symbol">—</span></span>
        <span class="chip">tf: <span id="a-tf">—</span></span>
      </div>
      <div class="kv">
        <div>regime</div><div id="a-regime">—</div>
        <div>bias</div><div id="a-bias">—</div>
        <div>confidence</div><div id="a-conf">—</div>
        <div>price</div><div id="a-price">—</div>
        <div>bar (UTC)</div><div id="a-t_utc">—</div>
        <div>analyzed_at</div><div id="a-an">—</div>
      </div>
      <div class="hint">JSON ответа:</div>
      <pre id="a-pre">—</pre>
    </div>
  </section>

  <!-- B -->
  <section class="card" style="grid-area:b">
    <h2>Сигнал входа (коридор)</h2>
    <div class="content">
      <div class="row">
        <span class="chip">symbol: <span id="e-symbol">—</span></span>
        <span class="chip">tf: <span id="e-tf">—</span></span>
      </div>
      <div class="kv">
        <div>regime</div><div id="e-regime">—</div>
        <div>bias</div><div id="e-bias">—</div>
        <div>confidence</div><div id="e-conf">—</div>
        <div>price</div><div id="e-price">—</div>
        <div>bar (UTC)</div><div id="e-t_utc">—</div>
        <div>analyzed_at</div><div id="e-an">—</div>
      </div>
      <div class="hint">JSON ответа:</div>
      <pre id="e-pre">—</pre>
    </div>
  </section>

  <!-- C -->
  <section class="card" style="grid-area:c">
    <h2>Последние записи (строго UTC)</h2>
    <div class="content">
      <pre id="s-pre">—</pre>
      <div class="hint">Источник: <span class="muted">/api/hud_api_strict.php</span></div>
    </div>
  </section>

  <!-- D -->
  <section class="card" style="grid-area:d">
    <h2>Диагностика запросов</h2>
    <div class="content">
      <pre id="log"></pre>
    </div>
  </section>
</main>

<script>
const $ = sel => document.querySelector(sel);
const log = (line, cls='') => {
  const ts = new Date().toISOString().replace('T',' ').replace('Z',' UTC');
  $('#log').textContent += `[${ts}] ${line}\n`;
  $('#log').scrollTop = $('#log').scrollHeight;
};

const api = {
  window(kind){ // 'analysis' | 'corridor'
    const sym = encodeURIComponent($('#sym').value.trim());
    const tf  = encodeURIComponent($('#tf').value.trim());
    const url = `/api/hud_ai.php?kind=${kind}&sym=${sym}&tf=${tf}`;
    return timedGET(url);
  },
  strict(){
    const sym = encodeURIComponent($('#sym').value.trim());
    const tf  = encodeURIComponent($('#tf').value.trim());
    const url = `/api/hud_api_strict.php?sym=${sym}&tf=${tf}&limit=3`;
    return timedGET(url);
  },
  probe(){
    return timedGET(`/analyze.php?mode=probe`);
  }
};

async function timedGET(url){
  const t0 = performance.now();
  let resp, text, json, ok=false;
  try{
    resp = await fetch(url, {cache:'no-store'});
    text = await resp.text();
    try{ json = JSON.parse(text); }catch{ json = null; }
    ok = resp.ok;
  }catch(e){
    text = String(e);
  }
  const ms = Math.round(performance.now() - t0);
  const status = ok ? '200' : (resp ? resp.status : 'ERR');
  log(`${status} ${url}  •  ${ms} ms`);
  return {ok, status, ms, text, json};
}

function fillAnalysis(prefix, data){
  // data — JSON из /api/hud_ai.php с блоком analysis
  const a = (data && data.analysis) ? data.analysis : null;
  const m = data?.meta || {};
  $(`#${prefix}-symbol`).textContent = m.symbol ?? '—';
  $(`#${prefix}-tf`).textContent     = (m.tf ?? '').toString() || '—';

  $(`#${prefix}-regime`).textContent = a?.regime ?? '—';
  $(`#${prefix}-bias`).textContent   = a?.bias ?? '—';
  $(`#${prefix}-conf`).textContent   = (a?.confidence ?? '—').toString();
  $(`#${prefix}-price`).textContent  = (a?.price ?? '—').toString();
  $(`#${prefix}-t_utc`).textContent  = a?.t_utc ?? '—';
  $(`#${prefix}-an`).textContent     = a?.analyzed_at ?? '—';
}

async function loadAll(){
  $('#ver').textContent = new Date().toISOString().slice(0,10);
  // 1) текущий анализ
  const now = await api.window('analysis');
  $('#a-pre').textContent = now.text || '—';
  if(now.json?.ok){ fillAnalysis('a', now.json); }

  // 2) коридор
  const entry = await api.window('corridor');
  $('#e-pre').textContent = entry.text || '—';
  if(entry.json?.ok){ fillAnalysis('e', entry.json); }

  // 3) строгие записи
  const s = await api.strict();
  $('#s-pre').textContent = s.text || '—';

  // 4) зонд
  const p = await api.probe();
  if(p.ok){ $('#oklamp').style.background = 'var(--green)'; }
  else    { $('#oklamp').style.background = 'var(--red)'; }
}

$('#btnNow').addEventListener('click', loadAll);
$('#btnCorridor').addEventListener('click', async ()=>{
  const entry = await api.window('corridor');
  $('#e-pre').textContent = entry.text || '—';
  if(entry.json?.ok){ fillAnalysis('e', entry.json); }
});

// автообновление лёгкое: каждые 60 сек подтягиваем только «текущий анализ»
setInterval(async ()=>{
  const now = await api.window('analysis');
  if(now.json?.ok){
    fillAnalysis('a', now.json);
    $('#a-pre').textContent = now.text || '—';
  }
}, 60000);

// первый рендер
loadAll();
</script>
</body>
</html>
