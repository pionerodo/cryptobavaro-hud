<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HUD Dashboard</title>
  <style>
    :root { --bg:#0f1216; --panel:#171b21; --muted:#8b97a8; --ok:#30d158; --err:#ff453a; --hl:#b6f397; --mono:#c0f2c0; }
    html,body{margin:0;padding:0;background:var(--bg);color:#e6eef7;font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";}
    .wrap{max-width:1400px;margin:18px auto;padding:0 14px;}
    .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .bar .sp{flex:1}
    .inp,.sel,.btn{height:36px;border-radius:8px;border:1px solid #2a2f38;background:#12161c;color:#e6eef7;padding:0 10px}
    .btn{background:#1e2430;border-color:#2f3642;cursor:pointer}
    .btn:hover{background:#222a37}
    .pill{padding:4px 10px;border-radius:999px;background:#141a22;border:1px solid #2a303a;color:var(--muted)}
    .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid #232a35;border-radius:12px;overflow:hidden}
    .card h3{margin:0;padding:10px 12px;border-bottom:1px solid #222a33;color:#a9b6c7;font-weight:600}
    .out{padding:10px 12px;overflow:auto;max-height:520px}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;color:var(--mono)}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .foot{margin-top:10px;color:#6b7686;text-align:right}
    .logline{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .log-ok{color:var(--ok)} .log-err{color:var(--err)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <strong class="pill">HUD Dashboard</strong>
    <span class="pill">Пара:</span>
    <input id="sym" class="inp" value="BINANCE:BTCUSDT" spellcheck="false" />
    <span class="pill">TF:</span>
    <select id="tf" class="sel">
      <option>1m</option><option selected>5m</option><option>15m</option>
      <option>1h</option><option>4h</option>
    </select>
    <button id="btnNow" class="btn">Получить анализ</button>
    <button id="btnWindow" class="btn">Проверить «коридор сделки»</button>
    <span id="probe" class="pill">OK</span>
    <span class="sp"></span>
    <span class="muted">ver: 2025‑08‑25</span>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Текущий анализ</h3>
      <div id="out_now" class="out"><pre class="muted">—</pre></div>
    </div>

    <div class="card">
      <h3>Сигнал входа (коридор)</h3>
      <div id="out_window" class="out"><pre class="muted">—</pre></div>
    </div>

    <div class="card" style="grid-column:1/2">
      <h3>Последние записи (строго UTC)</h3>
      <div id="out_strict" class="out"><pre class="muted">—</pre></div>
      <div class="foot muted">Источник данных: API HUD (/api/*)</div>
    </div>

    <div class="card" style="grid-column:2/3">
      <h3>Диагностика запросов</h3>
      <div id="diag" class="out"><pre class="muted">—</pre></div>
    </div>
  </div>
</div>

<script>
const qs = sel => document.querySelector(sel);
const symEl = qs('#sym');
const tfEl  = qs('#tf');
const outNow = qs('#out_now');
const outWindow = qs('#out_window');
const outStrict = qs('#out_strict');
const diag = qs('#diag');
const probeEl = qs('#probe');

const logs = [];
function log(line, ok=true){
  const ts = new Date().toISOString().replace('T',' ').replace('Z',' UTC');
  logs.unshift(`[${ts}] ${line}`);
  if(logs.length>80) logs.length=80;
  diag.innerHTML = `<pre>${logs.map(l=>{
    const cls = l.includes(' ERR ')||l.toLowerCase().includes('error') ? 'log-err' : 'log-ok';
    return `<span class="logline ${cls}">${l}</span>`;
  }).join('\n')}</pre>`;
}

function tfNum(){
  const m = String(tfEl.value||'5m').toLowerCase().match(/^(\d+)(m|h)$/);
  if(!m) return 5;
  const n = +m[1], u = m[2];
  return u==='m' ? n : n*60;
}

function pretty(json){
  try{ return JSON.stringify(json, null, 2); }
  catch(e){ return String(json); }
}

async function call(url, params){
  const u = new URL(url, location.origin);
  Object.entries(params||{}).forEach(([k,v])=> u.searchParams.set(k,v));
  const started = performance.now();
  const res = await fetch(u.toString(), {cache:'no-store'});
  const ms = Math.round(performance.now()-started);
  let body = '';
  try{ body = await res.text(); }catch{}
  let json;
  try{ json = JSON.parse(body); }catch(e){
    log(`ERR ${u.pathname}${u.search}  •  bad_json`, false);
    throw new Error('bad_json');
  }
  log(`${res.status} ${u.pathname}${u.search}  •  ${ms} ms`, res.ok);
  return json;
}

async function ping(){
  try{
    const u = new URL('/analyze.php', location.origin);
    u.search = '?mode=probe';
    const t0 = performance.now();
    const res = await fetch(u.toString(), {cache:'no-store'});
    const text = await res.text();
    const dt = Math.round(performance.now()-t0);
    if(res.ok && text.includes('alive')){
      probeEl.textContent = 'OK';
      probeEl.style.color = 'var(--ok)';
      log(`GET /analyze.php?mode=probe  •  ${dt} ms  ↳ BODY: ${text.trim()}`);
    }else{
      probeEl.textContent = 'ERR';
      probeEl.style.color = 'var(--err)';
      log(`ERR /analyze.php?mode=probe`, false);
    }
  }catch(e){
    probeEl.textContent = 'ERR';
    probeEl.style.color = 'var(--err)';
    log(`ERR /analyze.php?mode=probe`, false);
  }
}

async function loadNow(){
  const s = symEl.value.trim();
  try{
    const json = await call('/api/hud_ai.php', { mode:'now', sym:s, tf: tfNum() });
    outNow.innerHTML = `<pre>${pretty(json)}</pre>`;
  }catch(e){
    outNow.innerHTML = `<pre class="err">${e.message||'error'}</pre>`;
  }
}

async function loadWindow(){
  const s = symEl.value.trim();
  try{
    // ВАЖНО: быстрый фикс — используем mode=window (вместо mode=edge/kind=corridor)
    const json = await call('/api/hud_ai.php', { mode:'window', sym:s, tf: tfNum(), limit:3 });
    outWindow.innerHTML = `<pre>${pretty(json)}</pre>`;
  }catch(e){
    outWindow.innerHTML = `<pre class="err">${e.message||'error'}</pre>`;
  }
}

async function loadStrict(){
  const s = symEl.value.trim();
  try{
    const json = await call('/api/hud_api_strict.php', { sym:s, tf: tfNum(), limit:3 });
    outStrict.innerHTML = `<pre>${pretty(json)}</pre>`;
  }catch(e){
    outStrict.innerHTML = `<pre class="err">${e.message||'error'}</pre>`;
  }
}

qs('#btnNow').addEventListener('click', async ()=>{
  await loadNow(); await loadStrict();
});
qs('#btnWindow').addEventListener('click', async ()=>{
  await loadWindow(); await loadStrict();
});

(async function boot(){
  await ping();
  await loadNow();
  await loadWindow();
  await loadStrict();
  // автообновление блока анализа и строгих записей
  setInterval(()=>{ loadNow(); loadStrict(); }, 30_000);
})();
</script>
</body>
</html>
