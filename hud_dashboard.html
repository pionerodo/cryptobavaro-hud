<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HUD Dashboard</title>
  <style>
    :root{
      --bg:#0e1013; --card:#161a1f; --muted:#a9b0bb; --text:#e7ecf3; --ok:#36d399; --warn:#ffd166; --err:#ff6b6b;
      --accent:#3b82f6; --accent-2:#2563eb; --mono:#9fe870;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #1f242c}
    h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.2px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px}
    .card{background:var(--card);border:1px solid #212733;border-radius:12px;overflow:hidden}
    .card h3{margin:0;padding:10px 12px;border-bottom:1px solid #212733;font-size:13px;color:var(--muted);letter-spacing:.3px}
    .card .body{padding:12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    label{color:var(--muted);font-size:12px}
    input[type=text], select{
      background:#0f1318;color:var(--text);border:1px solid #2a3240;border-radius:8px;padding:8px 10px;outline:none;
    }
    button{
      background:var(--accent);color:#fff;border:none;border-radius:10px;padding:9px 12px;font-weight:600;cursor:pointer
    }
    button:hover{background:var(--accent-2)}
    .btn-ghost{background:#0f1318;border:1px solid #2a3240;color:var(--muted)}
    .status{font-size:12px;color:var(--ok);margin-left:auto}
    pre{
      margin:0;background:#0b0e12;border:1px solid #202632;border-radius:10px;padding:10px;overflow:auto;
      color:var(--mono);font:12px/1.45 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    }
    .stack{display:grid;gap:16px}
    .diag-line{color:#9be5a7;font:12px/1.4 ui-monospace,monospace;white-space:pre}
    .footer{padding:10px 16px;color:var(--muted);font-size:12px}
    .right{display:grid;gap:16px}
    @media (max-width:1100px){ .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <h1>HUD Dashboard</h1>
    <div class="controls">
      <label>–ü–∞—Ä–∞:</label>
      <input id="sym" type="text" value="BINANCE:BTCUSDT" spellcheck="false" />
      <label>TF:</label>
      <select id="tf">
        <option>1m</option><option selected>5m</option><option>15m</option><option>60m</option>
      </select>
      <button id="btnNow">–ü–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
      <button id="btnEntry" class="btn-ghost">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å ¬´–∫–æ—Ä–∏–¥–æ—Ä —Å–¥–µ–ª–∫–∏¬ª</button>
      <span id="ping" class="status">OK</span>
    </div>
  </header>

  <div class="row">
    <div class="stack">
      <div class="card">
        <h3>–¢–µ–∫—É—â–∏–π –∞–Ω–∞–ª–∏–∑</h3>
        <div class="body"><pre id="nowBox">‚Äî</pre></div>
      </div>

      <div class="card">
        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (—Å—Ç—Ä–æ–≥–æ UTC)</h3>
        <div class="body"><pre id="strictBox">‚Äî</pre></div>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <h3>–°–∏–≥–Ω–∞–ª –≤—Ö–æ–¥–∞ (–∫–æ—Ä–∏–¥–æ—Ä)</h3>
        <div class="body"><pre id="entryBox">‚Äî</pre></div>
      </div>

      <div class="card">
        <h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤</h3>
        <div class="body">
          <div id="diag"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: API HUD (<code>cryptobavaro.online/api/*</code>)</div>

  <script>
    const $ = s => document.querySelector(s);
    const diag = (txt, ok=true) => {
      const ts = new Date().toISOString().replace('T',' ').replace('Z','Z');
      const el = document.createElement('div');
      el.className = 'diag-line';
      el.style.color = ok ? '#9be5a7' : 'var(--err)';
      el.textContent = `[${ts}] ${txt}`;
      $('#diag').prepend(el);
    };

    const tfNum = (tfStr) => parseInt(tfStr.replace(/\D/g,''),10) || 5;

    async function fetchJSON(url) {
      const t0 = performance.now();
      try{
        const res = await fetch(url, {cache:'no-store'});
        const text = await res.text(); // —á–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        let json;
        try { json = JSON.parse(text); }
        catch(e){
          diag(`ERR ${res.status} ${url}\n‚Ü≥ BODY: ${text.slice(0,200)}‚Ä¶`, false);
          throw new Error('bad_json');
        }
        const ms = Math.round(performance.now() - t0);
        diag(`GET ${url}  ‚Ä¢ ${ms} ms`);
        return json;
      }catch(e){
        diag(`EXC ${url}  ‚Ä¢ ${e}`, false);
        throw e;
      }
    }

    // üîß –¥–ª—è /analyze.php?mode=probe ‚Äî —á–∏—Ç–∞–µ–º –∫–∞–∫ –¢–ï–ö–°–¢, –Ω–µ JSON
    async function fetchTEXT(url){
      const t0 = performance.now();
      const res = await fetch(url, {cache:'no-store'});
      const txt = await res.text();
      const ms = Math.round(performance.now() - t0);
      diag(`GET ${url}  ‚Ä¢ ${ms} ms`);
      return txt;
    }

    function pretty(target, data){
      $(target).textContent = JSON.stringify(data, null, 2);
    }

    function buildAiUrl(kind, sym, tf){
      // –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç
      const urlKind = `/api/hud_ai.php?kind=${encodeURIComponent(kind)}&sym=${encodeURIComponent(sym)}&tf=${tf}`;
      // –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
      const mode = (kind === 'analysis') ? 'now' : 'entry';
      const urlMode = `/api/hud_ai.php?mode=${mode}&sym=${encodeURIComponent(sym)}&tf=${tf}`;
      return {urlKind, urlMode};
    }

    async function callAI(kind){
      const sym = $('#sym').value.trim();
      const tf = tfNum($('#tf').value);

      const {urlKind, urlMode} = buildAiUrl(kind, sym, tf);

      try{
        const j = await fetchJSON(urlKind);
        return j;
      }catch(e){
        diag(`fallback ‚Üí ${urlMode}`);
        return await fetchJSON(urlMode);
      }
    }

    async function doNow(){
      const data = await callAI('analysis');
      pretty('#nowBox', data);
    }

    async function doEntry(){
      const data = await callAI('corridor');
      pretty('#entryBox', data);
    }

    async function loadStrict(){
      const sym = $('#sym').value.trim();
      const tf = tfNum($('#tf').value);
      const url = `/api/hud_api_strict.php?sym=${encodeURIComponent(sym)}&tf=${tf}&limit=3`;
      const j = await fetchJSON(url);
      pretty('#strictBox', j);
    }

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ¬´–¢–µ–∫—É—â–∏–π –∞–Ω–∞–ª–∏–∑¬ª —Ä–∞–∑ –≤ 60 —Å–µ–∫.
    let _autoTimer = null;
    function startAuto(){
      stopAuto();
      _autoTimer = setInterval(doNow, 60_000);
    }
    function stopAuto(){
      if(_autoTimer){ clearInterval(_autoTimer); _autoTimer = null; }
    }

    // UI
    $('#btnNow').addEventListener('click', async ()=>{ try{ await doNow(); }catch{} });
    $('#btnEntry').addEventListener('click', async ()=>{ try{ await doEntry(); }catch{} });
    $('#tf').addEventListener('change', async ()=>{ try{ await Promise.all([doNow(), doEntry(), loadStrict()]); }catch{} });
    $('#sym').addEventListener('keydown', e=>{
      if(e.key==='Enter'){ doNow().catch(()=>{}); loadStrict().catch(()=>{}); }
    });

    // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    (async ()=>{
      // ‚úÖ –ø—Ä–æ–±–Ω—ã–π –ø–∏–Ω–≥: —á–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç –∏ —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—Ö–æ–º –ª—é–±–æ–π 200 + –Ω–∞–ª–∏—á–∏–µ ¬´alive¬ª
      try{
        const txt = await fetchTEXT('/analyze.php?mode=probe');
        const ok = /alive/i.test(txt);
        $('#ping').textContent = ok ? 'OK' : 'ERR';
        $('#ping').style.color = ok ? 'var(--ok)' : 'var(--err)';
      }catch{
        $('#ping').textContent = 'ERR';
        $('#ping').style.color = 'var(--err)';
      }

      try{
        await doNow();
        await doEntry();
        await loadStrict();
        startAuto();
      }catch{}
    })();
  </script>
</body>
</html>
