<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HUD — BTC/USDT</title>

  <!-- Минималистичная тёмная тема без фреймворков -->
  <style>
    :root{
      --bg:#0f1720; --panel:#111b27; --panel2:#0d1620; --muted:#8aa0b2;
      --text:#e6f0f8; --accent:#6ee7b7; --warn:#f59e0b; --danger:#f87171; --line:#1e2a36;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      color:var(--text); background:var(--bg);
    }
    .wrap{max-width:1200px; margin:24px auto; padding:0 16px;}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .panel{background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px}
    .panel2{background:var(--panel2)}
    .muted{color:var(--muted)}
    .h{font-weight:600; letter-spacing:.2px}
    .kpi{flex:1; min-width:230px}
    .kpi .hint{font-size:12px; color:var(--muted)}
    .kpi .val{font-size:18px; margin-top:6px}
    .controls{align-items:center; gap:12px}
    label{font-size:12px; color:var(--muted); margin-right:6px}
    input,select,button{
      background:#0a131c; color:var(--text); border:1px solid var(--line); border-radius:10px; height:36px;
      padding:0 10px; outline:none;
    }
    input::placeholder{color:#5e778d}
    button{cursor:pointer; background:#143047; border-color:#1c415b}
    button:hover{filter:brightness(1.08)}
    .switch{display:inline-flex; align-items:center; gap:8px}
    .badge{display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; line-height:1; border:1px solid var(--line); background:#0a131c}
    .grid2{display:grid; grid-template-columns:1.1fr .9fr; gap:12px}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    .levels table{width:100%; border-collapse:collapse}
    .levels th,.levels td{padding:10px 8px; border-top:1px solid var(--line); text-align:left}
    .levels th{color:var(--muted); font-weight:500; font-size:12px}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--line); font-size:12px}
    .ok{color:var(--accent)} .warn{color:var(--warn)} .err{color:var(--danger)}
    .note{white-space:pre-wrap}
    .empty{color:var(--muted); font-style:italic}
    .right{display:flex; justify-content:flex-end; gap:8px}
    .foot{margin-top:8px; font-size:12px; color:var(--muted)}
    canvas{max-width:100%; height:260px}
  </style>

  <!-- Chart.js для пончика -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <!-- Контролы -->
    <div class="row controls">
      <div>
        <label for="symbol">Символ</label>
        <input id="symbol" value="BTCUSDT" spellcheck="false" />
      </div>
      <div>
        <label for="tf">ТФ</label>
        <select id="tf">
          <option value="1">1</option>
          <option value="5" selected>5</option>
          <option value="15">15</option>
          <option value="60">60</option>
          <option value="240">240</option>
        </select>
      </div>
      <label class="switch">
        <input id="auto" type="checkbox" checked />
        авто‑обновление
      </label>
      <button id="reload">Обновить</button>
      <div class="muted" id="status">Нет данных</div>
    </div>

    <!-- KPI -->
    <div class="row" style="margin-top:12px">
      <div class="panel kpi">
        <div class="hint">Режим</div>
        <div class="val" id="k_mode">—</div>
      </div>
      <div class="panel kpi">
        <div class="hint">Направление</div>
        <div class="val" id="k_dir">—</div>
      </div>
      <div class="panel kpi">
        <div class="hint">Уверенность</div>
        <div class="val" id="k_conf">—</div>
      </div>
      <div class="panel kpi">
        <div class="hint">Время</div>
        <div class="val" id="k_time">—</div>
      </div>
      <div class="panel kpi">
        <div class="hint">Цена</div>
        <div class="val" id="k_price">—</div>
      </div>
    </div>

    <!-- Заметки -->
    <div class="panel" style="margin-top:12px">
      <div class="h">Заметки</div>
      <div class="muted foot">— нет заметок —</div>
      <div class="note" id="notes"></div>
    </div>

    <!-- Вероятности + легенда -->
    <div class="panel grid2" style="margin-top:12px">
      <div>
        <div class="h">Распределение вероятностей</div>
        <div class="muted foot">тренд / флэт / расширение</div>
        <div style="padding:8px 0 0 0">
          <canvas id="pie"></canvas>
        </div>
        <div class="row" style="gap:12px; padding-top:6px">
          <span class="pill">● тренд</span>
          <span class="pill">● флэт</span>
          <span class="pill">● расширение</span>
        </div>
      </div>
      <div>
        <div class="h">Сводка</div>
        <div style="margin-top:10px">
          <div class="row" style="justify-content:space-between">
            <span class="muted">тренд</span><span id="s_trend" class="badge">—</span>
          </div>
          <div class="row" style="justify-content:space-between; margin-top:8px">
            <span class="muted">флэт (диапазон)</span><span id="s_flat" class="badge">—</span>
          </div>
          <div class="row" style="justify-content:space-between; margin-top:8px">
            <span class="muted">расширение</span><span id="s_expand" class="badge">—</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Ближайшие уровни -->
    <div class="panel levels" style="margin-top:12px">
      <div class="h">Ближайшие уровни</div>
      <div class="muted foot">Δ ATR — относительная «дистанция» уровня</div>
      <table id="lvlTable" style="margin-top:8px">
        <thead>
          <tr><th>Тип уровня</th><th>Уровень</th><th>Δ ATR</th></tr>
        </thead>
        <tbody id="lvlBody">
          <tr><td colspan="3" class="empty">— нет уровней —</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Ключевые сигналы -->
    <div class="panel" style="margin-top:12px">
      <div class="h">Ключевые сигналы</div>
      <div class="muted foot">Вес 0..1 — вклад признака в итоговую оценку</div>
      <div id="signals" class="empty" style="margin-top:8px">— нет сигналов —</div>
    </div>

    <!-- Плейбук -->
    <div class="panel" style="margin-top:12px">
      <div class="h">Плейбук (сценарии)</div>
      <div id="playbook" class="empty" style="margin-top:8px">— сценариев нет —</div>
    </div>

    <div class="foot right">
      <span>API: <code>/latest_analysis.php?symbol=…&tf=…</code></span>
    </div>
  </div>

  <script>
    // ---------- утилы ----------
    const $ = sel => document.querySelector(sel);
    const fmt = new Intl.NumberFormat('ru-RU', {maximumFractionDigits: 2});
    const fmtInt = new Intl.NumberFormat('ru-RU', {maximumFractionDigits: 0});
    function tsToLocal(ms){
      if(!ms) return "—";
      try{
        const d = new Date(Number(ms));
        return d.toLocaleString();
      }catch{ return "—"; }
    }
    function safe(v, def="—"){ return (v===undefined || v===null || v==='') ? def : v; }

    // ---------- состояние ----------
    let timer = null;
    let pie = null;

    function buildUrl(){
      let sym = $('#symbol').value.trim();
      if(sym && !sym.includes(':')) sym = 'BINANCE:' + sym;
      const tf = $('#tf').value;
      const u = new URL(location.origin + '/latest_analysis.php');
      if(sym) u.searchParams.set('symbol', sym);
      u.searchParams.set('tf', tf);
      return u.toString();
    }

    async function load(){
      const url = buildUrl();
      $('#status').textContent = 'Запрос…';
      try{
        const res = await fetch(url, {cache:'no-store'});
        const data = await res.json();
        if(!data || data.status!=='ok' || !data.found){
          $('#status').textContent = 'Нет данных';
          paintEmpty();
          return;
        }
        $('#status').textContent = `OK · snapshot #${data.snapshot_id||'?'}`;
        paint(data);
      }catch(e){
        console.error(e);
        $('#status').textContent = 'Ошибка сети';
      }
    }

    function startAuto(){
      stopAuto();
      if($('#auto').checked){
        timer = setInterval(load, 15000);
      }
    }
    function stopAuto(){ if(timer){ clearInterval(timer); timer=null; } }

    // ---------- отрисовка ----------
    function paintEmpty(){
      $('#k_mode').textContent = '—';
      $('#k_dir').textContent = '—';
      $('#k_conf').textContent = '—';
      $('#k_time').textContent = '—';
      $('#k_price').textContent = '—';
      $('#notes').textContent = '';
      $('#notes').previousElementSibling.style.display = '';
      $('#lvlBody').innerHTML = `<tr><td colspan="3" class="empty">— нет уровней —</td></tr>`;
      $('#signals').textContent = '— нет сигналов —';
      $('#signals').classList.add('empty');
      $('#playbook').textContent = '— сценариев нет —';
      $('#playbook').classList.add('empty');
      updatePie(0,0,0);
      $('#s_trend').textContent = '—';
      $('#s_flat').textContent  = '—';
      $('#s_expand').textContent= '—';
    }

    function paint(d){
      // KPI
      const f = d.f || {};
      $('#k_mode').textContent = safe(f.mm, '—');
      $('#k_dir').textContent  = '—'; // в текущем API нет явного направления
      $('#k_conf').textContent = (d.analysis && typeof d.analysis.confidence==='number')
        ? `${d.analysis.confidence}%` : '—';
      $('#k_time').textContent  = tsToLocal(d.ts);
      $('#k_price').textContent = (typeof d.p==='number') ? fmt.format(d.p) : '—';

      // Заметки
      const notes = (d.analysis && d.analysis.notes) ? String(d.analysis.notes).trim() : '';
      $('#notes').textContent = notes;
      $('#notes').previousElementSibling.style.display = notes ? 'none' : '';

      // Распределение (если нет — делаем аккуратный фолбэк)
      // Здесь подразумевается простая индикация: текущий режим = 1, остальные = 0
      let trend=0, flat=0, expand=0;
      const mm = (f.mm||'').toLowerCase();
      if(mm.includes('trend') || mm.includes('тренд')) trend = 1;
      else if(mm.includes('expand') || mm.includes('расшир')) expand = 1;
      else flat = 1;
      updatePie(trend, flat, expand);
      $('#s_trend').textContent  = trend ? 'активен' : 'нет';
      $('#s_flat').textContent   = flat  ? 'активен' : 'нет';
      $('#s_expand').textContent = expand? 'активен' : 'нет';

      // Уровни
      const lv = Array.isArray(d.lv)? d.lv : [];
      if(lv.length){
        $('#lvlBody').innerHTML = lv.map(x=>`
          <tr>
            <td><span class="pill">${safe(x.t,'—')}</span></td>
            <td>${x.lv!==undefined ? fmtInt.format(x.lv) : '—'}</td>
            <td>${x.da!==undefined ? fmt.format(x.da) : '—'}</td>
          </tr>
        `).join('');
      }else{
        $('#lvlBody').innerHTML = `<tr><td colspan="3" class="empty">— нет уровней —</td></tr>`;
      }

      // Плейбук
      const pb = (d.analysis && Array.isArray(d.analysis.playbook)) ? d.analysis.playbook : [];
      const pbBox = $('#playbook');
      if(pb.length){
        pbBox.classList.remove('empty');
        pbBox.innerHTML = `<ul style="margin:6px 0 0 16px">${pb.map(i=>`<li>${escapeHtml(String(i))}</li>`).join('')}</ul>`;
      }else{
        pbBox.classList.add('empty');
        pbBox.textContent = '— сценариев нет —';
      }

      // Сигналы (в текущем ответе нет — оставляем плейсхолдер)
      const sig = $('#signals');
      sig.classList.add('empty');
      sig.textContent = '— нет сигналов —';
    }

    function updatePie(a,b,c){
      const ctx = $('#pie');
      const data = [a,b,c];
      const colors = ['#34d399','#a78bfa','#60a5fa'];
      if(pie){ pie.data.datasets[0].data = data; pie.update(); return; }
      pie = new Chart(ctx, {
        type:'doughnut',
        data:{ labels:['тренд','флэт','расширение'], datasets:[{ data, backgroundColor:colors, borderColor:'#0a131c', borderWidth:2 }]},
        options:{ plugins:{legend:{display:false}}, cutout:'65%' }
      });
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
    }

    // ---------- события ----------
    $('#reload').addEventListener('click', load);
    $('#auto').addEventListener('change', startAuto);
    $('#symbol').addEventListener('keydown', e=>{ if(e.key==='Enter') load(); });
    $('#tf').addEventListener('change', load);

    // первый запуск
    load();
    startAuto();
  </script>
</body>
</html>
