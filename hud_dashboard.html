<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>HUD Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background-color: #111;
      color: #ddd;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    select, input, button {
      padding: 6px 10px;
      border-radius: 4px;
      border: none;
    }
    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .card {
      background: #1c1c1c;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 5px #000;
    }
    .ok {
      color: #4caf50;
      font-weight: bold;
    }
    pre {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
    }
    .playbook {
      margin-top: 10px;
    }
    .scenario {
      background: #222;
      border-left: 4px solid #007bff;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 6px;
    }
    .scenario strong {
      color: #ffa500;
    }
    .footer {
      margin-top: 20px;
      text-align: center;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>HUD Dashboard</h1>

  <div class="controls">
    <label>Пара: <input type="text" id="symbol" value="BINANCE:BTCUSDT"></label>
    <label>TF:
      <select id="tf">
        <option value="1">1m</option>
        <option value="5" selected>5m</option>
        <option value="15">15m</option>
        <option value="60">1h</option>
      </select>
    </label>
    <button onclick="getAnalysis()">Получить анализ</button>
    <button onclick="getSignal()">Проверить «коридор сделки»</button>
    <span id="status" class="ok">OK</span>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Текущий анализ</h3>
      <div id="analysis"></div>
    </div>
    <div class="card">
      <h3>Сигнал входа (коридор)</h3>
      <div id="signal"></div>
    </div>
    <div class="card">
      <h3>Последние записи (строго UTC)</h3>
      <pre id="strict"></pre>
    </div>
    <div class="card">
      <h3>Диагностика запросов</h3>
      <pre id="logs"></pre>
    </div>
  </div>

  <div class="footer">
    Источник данных: API HUD (cryptobavaro.online/api/*)
  </div>

  <script>
    async function fetchJSON(url) {
      try {
        const r = await fetch(url);
        return await r.json();
      } catch (e) {
        return { ok: false, error: e.toString() };
      }
    }

    async function getAnalysis() {
      const sym = document.getElementById("symbol").value;
      const tf = document.getElementById("tf").value;
      const url = `/api/hud_ai.php?mode=now&sym=${sym}&tf=${tf}`;
      const data = await fetchJSON(url);
      renderAnalysis(data, "analysis");
      logRequest(url);
    }

    async function getSignal() {
      const sym = document.getElementById("symbol").value;
      const tf = document.getElementById("tf").value;
      const url = `/api/hud_ai.php?mode=entry&sym=${sym}&tf=${tf}`;
      const data = await fetchJSON(url);
      renderAnalysis(data, "signal");
      logRequest(url);
    }

    async function autoUpdate() {
      getAnalysis();
      getSignal();
      const sym = document.getElementById("symbol").value;
      const tf = document.getElementById("tf").value;
      const strict = await fetchJSON(`/api/hud_api_strict.php?sym=${sym}&tf=${tf}&limit=3`);
      document.getElementById("strict").textContent = JSON.stringify(strict, null, 2);
    }

    function renderAnalysis(data, id) {
      const container = document.getElementById(id);
      if (!data || !data.ok) {
        container.innerHTML = `<pre>Ошибка: ${data.error || "Нет данных"}</pre>`;
        return;
      }
      const notes = data.ai?.notes || "—";
      let html = `<p>${notes}</p>`;
      if (data.ai?.playbook) {
        html += `<div class="playbook">`;
        data.ai.playbook.forEach((sc, i) => {
          html += `
            <div class="scenario">
              <strong>Сценарий ${i + 1} (${sc.dir.toUpperCase()})</strong><br>
              Сетап: ${sc.setup}<br>
              Вход: ${sc.entry}<br>
              Инвалидация: ${sc.invalidation}<br>
              TP1: ${sc.tp1}, TP2: ${sc.tp2}<br>
              Уверенность: ${sc.confidence}%
            </div>`;
        });
        html += `</div>`;
      }
      container.innerHTML = html;
    }

    function logRequest(url) {
      const logs = document.getElementById("logs");
      const ts = new Date().toISOString();
      logs.textContent = `[${ts}] GET ${url}\n` + logs.textContent;
    }

    setInterval(autoUpdate, 60000); // авто-обновление каждую минуту
  </script>
</body>
</html>
