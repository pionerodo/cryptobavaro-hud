<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HUD Dashboard</title>
  <style>
    :root{
      --bg:#0e1013; --card:#161a1f; --muted:#a9b0bb; --text:#e7ecf3; --ok:#36d399; --warn:#ffd166; --err:#ff6b6b;
      --accent:#3b82f6; --accent-2:#2563eb; --mono:#9fe870;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #1f242c}
    h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.2px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px}
    .card{background:var(--card);border:1px solid #212733;border-radius:12px;overflow:hidden}
    .card h3{margin:0;padding:10px 12px;border-bottom:1px solid #212733;font-size:13px;color:var(--muted);letter-spacing:.3px}
    .card .body{padding:12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    label{color:var(--muted);font-size:12px}
    input[type=text], select{
      background:#0f1318;color:var(--text);border:1px solid #2a3240;border-radius:8px;padding:8px 10px;outline:none;
    }
    button{
      background:var(--accent);color:#fff;border:none;border-radius:10px;padding:9px 12px;font-weight:600;cursor:pointer
    }
    button:hover{background:var(--accent-2)}
    .btn-ghost{background:#0f1318;border:1px solid #2a3240;color:var(--muted)}
    .status{font-size:12px;color:var(--ok);margin-left:auto}
    pre{
      margin:0;background:#0b0e12;border:1px solid #202632;border-radius:10px;padding:10px;overflow:auto;
      color:var(--mono);font:12px/1.45 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    }
    .stack{display:grid;gap:16px}
    .diag-line{color:#9be5a7;font:12px/1.4 ui-monospace,monospace;white-space:pre}
    .footer{padding:10px 16px;color:var(--muted);font-size:12px}
    .right{display:grid;gap:16px}
    @media (max-width:1100px){ .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <h1>HUD Dashboard</h1>
    <div class="controls">
      <label>Пара:</label>
      <input id="sym" type="text" value="BINANCE:BTCUSDT" spellcheck="false" />
      <label>TF:</label>
      <select id="tf">
        <option>1m</option><option selected>5m</option><option>15m</option><option>60m</option>
      </select>
      <button id="btnNow">Получить анализ</button>
      <button id="btnEntry" class="btn-ghost">Проверить «коридор сделки»</button>
      <span id="ping" class="status">OK</span>
    </div>
  </header>

  <div class="row">
    <div class="stack">
      <div class="card">
        <h3>Текущий анализ</h3>
        <div class="body"><pre id="nowBox">—</pre></div>
      </div>

      <div class="card">
        <h3>Последние записи (строго UTC)</h3>
        <div class="body"><pre id="strictBox">—</pre></div>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <h3>Сигнал входа (коридор)</h3>
        <div class="body"><pre id="entryBox">—</pre></div>
      </div>

      <div class="card">
        <h3>Диагностика запросов</h3>
        <div class="body">
          <div id="diag"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">Источник данных: API HUD (<code>cryptobavaro.online/api/*</code>)</div>

  <script>
    const $ = s => document.querySelector(s);
    const diag = (txt, ok=true) => {
      const ts = new Date().toISOString().replace('T',' ').replace('Z','Z');
      const el = document.createElement('div');
      el.className = 'diag-line';
      el.style.color = ok ? '#9be5a7' : 'var(--err)';
      el.textContent = `[${ts}] ${txt}`;
      $('#diag').prepend(el);
    };

    const sleep = ms => new Promise(r => setTimeout(r, ms));
    const tfNum = (tfStr) => parseInt(tfStr.replace(/\D/g,''),10) || 5;

    async function fetchJSON(url) {
      const t0 = performance.now();
      try{
        const res = await fetch(url, {cache:'no-store'});
        const text = await res.text(); // читаем как текст для диагностики
        let json;
        try { json = JSON.parse(text); }
        catch(e){
          diag(`ERR ${res.status} ${url}\n↳ BODY: ${text.slice(0,200)}…`, false);
          throw new Error('bad_json');
        }
        const ms = Math.round(performance.now() - t0);
        diag(`GET ${url}  • ${ms} ms`);
        return json;
      }catch(e){
        diag(`EXC ${url}  • ${e}`, false);
        throw e;
      }
    }

    function pretty(target, data){
      $(target).textContent = JSON.stringify(data, null, 2);
    }

    function buildAiUrl(kind, sym, tf){
      // основной вариант (новый): kind=analysis|corridor
      const urlKind = `/api/hud_ai.php?kind=${encodeURIComponent(kind)}&sym=${encodeURIComponent(sym)}&tf=${tf}`;
      // fallback (старый): mode=now|entry
      const mode = (kind === 'analysis') ? 'now' : 'entry';
      const urlMode = `/api/hud_ai.php?mode=${mode}&sym=${encodeURIComponent(sym)}&tf=${tf}`;
      return {urlKind, urlMode};
    }

    async function callAI(kind){
      const sym = $('#sym').value.trim();
      const tf = tfNum($('#tf').value);

      const {urlKind, urlMode} = buildAiUrl(kind, sym, tf);

      // 1) пробуем новый контракт
      try{
        const j = await fetchJSON(urlKind);
        return j;
      }catch(e){
        // 2) если сервер ещё на старом контракте — попробуем mode=…
        diag(`fallback → ${urlMode}`);
        return await fetchJSON(urlMode);
      }
    }

    async function doNow(){
      const data = await callAI('analysis');
      pretty('#nowBox', data);
    }

    async function doEntry(){
      const data = await callAI('corridor');
      pretty('#entryBox', data);
    }

    async function loadStrict(){
      const sym = $('#sym').value.trim();
      const tf = tfNum($('#tf').value);
      const url = `/api/hud_api_strict.php?sym=${encodeURIComponent(sym)}&tf=${tf}&limit=3`;
      const j = await fetchJSON(url);
      pretty('#strictBox', j);
    }

    // Автообновление «Текущий анализ» раз в 60 сек.
    let _autoTimer = null;
    function startAuto(){
      stopAuto();
      _autoTimer = setInterval(doNow, 60_000);
    }
    function stopAuto(){
      if(_autoTimer){ clearInterval(_autoTimer); _autoTimer = null; }
    }

    // UI
    $('#btnNow').addEventListener('click', async ()=>{
      try{ await doNow(); }catch{}
    });
    $('#btnEntry').addEventListener('click', async ()=>{
      try{ await doEntry(); }catch{}
    });
    $('#tf').addEventListener('change', async ()=>{
      // при смене ТФ подгружаем свежие блоки
      try{ await Promise.all([doNow(), doEntry(), loadStrict()]); }catch{}
    });
    $('#sym').addEventListener('keydown', e=>{
      if(e.key==='Enter'){ doNow().catch(()=>{}); loadStrict().catch(()=>{}); }
    });

    // Первичная загрузка
    (async ()=>{
      // «пробный пинг» бэкенда
      try{
        const ping = await fetchJSON('/analyze.php?mode=probe');
        $('#ping').textContent = 'OK';
        $('#ping').style.color = 'var(--ok)';
      }catch{
        $('#ping').textContent = 'ERR';
        $('#ping').style.color = 'var(--err)';
      }

      try{
        await doNow();
        await doEntry();
        await loadStrict();
        startAuto();
      }catch{}
    })();
  </script>
</body>
</html>
